# Test workflow for building wheels - can be manually triggered
name: Test Build

on:
  workflow_dispatch:
    inputs:
      build_linux:
        description: 'Build Linux wheels'
        required: false
        default: true
        type: boolean
      build_macos:
        description: 'Build macOS wheels'
        required: false
        default: false
        type: boolean
      build_windows:
        description: 'Build Windows wheels'
        required: false
        default: true
        type: boolean

jobs:
  build_linux:
    if: ${{ github.event.inputs.build_linux == 'true' }}
    name: Linux Wheels (Test)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install cibuildwheel
      run: python3 -m pip install cibuildwheel==2.11.2

    - name: Build wheels
      run: python3 -m cibuildwheel --output-dir wheelhouse
      env:
        CIBW_SKIP: "*musllinux* pp* *-manylinux_i686"
        CIBW_BUILD_VERBOSITY: 1

    - uses: actions/upload-artifact@v3
      with:
        name: linux-wheels
        path: ./wheelhouse/*.whl

  build_macos:
    if: ${{ github.event.inputs.build_macos == 'true' }}
    name: Macos Wheels (Test)
    runs-on: macos-11
    strategy:
      matrix:
        python-version: ['3.10']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install cibuildwheel
      run: python3 -m pip install cibuildwheel==2.11.2

    - name: Build wheels
      run: python3 -m cibuildwheel --output-dir wheelhouse
      env:
        # Apple M1 and Intel
        CIBW_ARCHS_MACOS: x86_64 arm64
        CIBW_SKIP: "pp*"
        CIBW_BUILD_VERBOSITY: 1

    - uses: actions/upload-artifact@v3
      with:
        name: macos-wheels
        path: ./wheelhouse/*.whl

  build_windows:
    if: ${{ github.event.inputs.build_windows == 'true' }}
    name: Windows Wheels (Test)
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.10']

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'

    - name: Install zlib via vcpkg
      run: |
        ${{ github.workspace }}\vcpkg\vcpkg.exe install zlib:x64-windows
      shell: pwsh

    - name: Install cibuildwheel
      run: python -m pip install cibuildwheel==2.11.2

    - name: Build wheels
      run: python -m cibuildwheel --output-dir wheelhouse
      env:
        CIBW_SKIP: "pp* *-win32"
        CIBW_BUILD_VERBOSITY: 1
        VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        CIBW_ENVIRONMENT_WINDOWS: "VCPKG_ROOT=${{ github.workspace }}\\vcpkg"
        CIBW_BEFORE_BUILD_WINDOWS: "pip install delvewheel"
        CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: "delvewheel repair -w {dest_dir} {wheel} --add-path ${{ github.workspace }}\\vcpkg\\installed\\x64-windows\\bin"

    - uses: actions/upload-artifact@v3
      with:
        name: windows-wheels
        path: ./wheelhouse/*.whl

  build_sdist:
    name: Build Source Distribution (Test)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build sdist
        run: pipx run build --sdist

      - uses: actions/upload-artifact@v3
        with:
          name: source-dist
          path: dist/*.tar.gz
